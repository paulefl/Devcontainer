name: Build Devcontainer (Podman, no push)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      IMAGE_NAME: my-devcontainer
      IMAGE_TAG: ci

    steps:
      - uses: actions/checkout@v4
      
      - name: Cache
        uses: actions/cache@v5.0.3
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: 
          # An explicit key for restoring and saving the cache
          key: 
          # An ordered multiline string listing the prefix-matched keys, that are used for restoring stale cache if no cache hit occurred for key. Note `cache-hit` returns false in this case.
          restore-keys: # optional
          # The chunk size used to split up large files during upload, in bytes
          upload-chunk-size: # optional
          # An optional boolean when enabled, allows windows runners to save or restore caches that can be restored or saved respectively on other platforms
          enableCrossOsArchive: # optional, default is false
          # Fail the workflow if cache entry is not found
          fail-on-cache-miss: # optional, default is false
          # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
          lookup-only: # optional, default is false
          # Run the post step to save the cache even if another step before fails
          save-always: # optional, default is false
          
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build image
        run: |
          podman build \
            -f .devcontainer/Dockerfile \
            -t $IMAGE_NAME:$IMAGE_TAG \
            .

      - name: Inspect image
        run: |
          podman inspect $IMAGE_NAME:$IMAGE_TAG \
            --format='IMAGE_ID={{.Id}}\nCREATED={{.Created}}\nSIZE={{.Size}}' \
            > image-info.txt

      - name: Export image (OCI)
        run: |
          podman save \
            --format oci-archive \
            -o devcontainer-image.oci \
            $IMAGE_NAME:$IMAGE_TAG

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: devcontainer-image
          path: devcontainer-image.oci

      - name: Write summary
        run: |
          {
            echo "## ðŸ“¦ Devcontainer Image (no push)"
            echo ""
            echo "- **Image:** \`$IMAGE_NAME:$IMAGE_TAG\`"
            echo "- **Image ID:** \`$(podman inspect --format='{{.Id}}' $IMAGE_NAME:$IMAGE_TAG)\`"
            echo "- **Created:** \`$(podman inspect --format='{{.Created}}' $IMAGE_NAME:$IMAGE_TAG)\`"
            echo "- **Size:** \`$(podman inspect --format='{{.Size}}' $IMAGE_NAME:$IMAGE_TAG)\` bytes"
            echo ""
            echo "â¬‡ï¸ **Download:** Artifact â†’ devcontainer-image"
          } >> $GITHUB_STEP_SUMMARY
